name: Build and Release RemMeter

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    - name: Restore dependencies
      run: dotnet restore wpf/RemMeter.csproj
      
    - name: Build
      run: dotnet build wpf/RemMeter.csproj --no-restore --configuration Release
      
    # Framework-dependent builds (å°ã•ã„ã‚µã‚¤ã‚ºã€.NET 8.0ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¿…è¦)
    - name: Publish Framework-dependent Windows x64
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x64 --self-contained false --output ./publish/framework-dependent/win-x64 --property:PublishSingleFile=true
      
    - name: Publish Framework-dependent Windows x86
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x86 --self-contained false --output ./publish/framework-dependent/win-x86 --property:PublishSingleFile=true
      
    # Self-contained builds (å¤§ãã„ã‚µã‚¤ã‚ºã€.NETãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸è¦)
    - name: Publish Self-contained Windows x64
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x64 --self-contained true --output ./publish/self-contained/win-x64 --property:PublishSingleFile=true --property:PublishTrimmed=false
      
    - name: Publish Self-contained Windows x86
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x86 --self-contained true --output ./publish/self-contained/win-x86 --property:PublishSingleFile=true --property:PublishTrimmed=false
      
    # Framework-dependent artifacts
    - name: Upload Framework-dependent Windows x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: RemMeter-framework-dependent-win-x64
        path: ./publish/framework-dependent/win-x64/RemMeter.exe
        
    - name: Upload Framework-dependent Windows x86 artifact
      uses: actions/upload-artifact@v4
      with:
        name: RemMeter-framework-dependent-win-x86
        path: ./publish/framework-dependent/win-x86/RemMeter.exe
        
    # Self-contained artifacts
    - name: Upload Self-contained Windows x64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: RemMeter-self-contained-win-x64
        path: ./publish/self-contained/win-x64/RemMeter.exe
        
    - name: Upload Self-contained Windows x86 artifact
      uses: actions/upload-artifact@v4
      with:
        name: RemMeter-self-contained-win-x86
        path: ./publish/self-contained/win-x86/RemMeter.exe

  release-latest:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Create release directory and copy files
      run: |
        mkdir -p release
        cp "./artifacts/RemMeter-framework-dependent-win-x64/RemMeter.exe" "./release/RemMeter-framework-dependent-win-x64.exe"
        cp "./artifacts/RemMeter-framework-dependent-win-x86/RemMeter.exe" "./release/RemMeter-framework-dependent-win-x86.exe"
        cp "./artifacts/RemMeter-self-contained-win-x64/RemMeter.exe" "./release/RemMeter-self-contained-win-x64.exe"
        cp "./artifacts/RemMeter-self-contained-win-x86/RemMeter.exe" "./release/RemMeter-self-contained-win-x86.exe"
        
    - name: Delete previous latest release
      run: |
        if gh release view latest >/dev/null 2>&1; then
          echo "Deleting existing latest release..."
          gh release delete latest --yes --cleanup-tag
        else
          echo "No previous latest release found"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Latest Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: "Latest Build"
        body: |
          ## RemMeter - Latest Build
          
          ğŸš€ **Automatic build from the latest master branch**
          
          ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
          
          ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          #### ğŸ¯ æ¨å¥¨ï¼šFramework-dependentç‰ˆï¼ˆå°ã•ã„ã‚µã‚¤ã‚ºï¼‰
          - **RemMeter-framework-dependent-win-x64.exe** - 64bit Windowsç”¨ï¼ˆç´„5-10MBï¼‰
          - **RemMeter-framework-dependent-win-x86.exe** - 32bit Windowsç”¨ï¼ˆç´„5-10MBï¼‰
          
          âš ï¸ **è¦ä»¶**: .NET 8.0 Desktop RuntimeãŒå¿…è¦ã§ã™
          - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ã‚¢ãƒ—ãƒªå®Ÿè¡Œæ™‚ã«è‡ªå‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã«æ¡ˆå†…ã•ã‚Œã¾ã™
          - [.NET 8.0 Desktop Runtime ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://dotnet.microsoft.com/download/dotnet/8.0)
          
          #### ğŸ”§ Self-containedç‰ˆï¼ˆå¤§ãã„ã‚µã‚¤ã‚ºã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸è¦ï¼‰
          - **RemMeter-self-contained-win-x64.exe** - 64bit Windowsç”¨ï¼ˆç´„80-120MBï¼‰
          - **RemMeter-self-contained-win-x86.exe** - 32bit Windowsç”¨ï¼ˆç´„80-120MBï¼‰
          
          âœ… **.NETãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸è¦** - ã©ã®Windows PCã§ã‚‚ãã®ã¾ã¾å®Ÿè¡Œå¯èƒ½
          
          ### âœ¨ ä¸»è¦æ©Ÿèƒ½
          - **4ã¤ã®é…ç½®ä½ç½®**: å³ç«¯ãƒ»å·¦ç«¯ãƒ»ä¸Šç«¯ãƒ»ä¸‹ç«¯ã‹ã‚‰é¸æŠå¯èƒ½
          - **ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼å¯¾å¿œ**: è¡¨ç¤ºã™ã‚‹ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼ã‚’é¸æŠå¯èƒ½
          - **è¦–è¦šçš„ãªé€²æ—è¡¨ç¤º**: æ®µéšçš„ãªè‰²å¤‰åŒ–ï¼ˆç·‘â†’ã‚ªãƒ¬ãƒ³ã‚¸â†’èµ¤è‰²ç‚¹æ»…ï¼‰
          - **Always on top**: ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¸Šã«å¸¸ã«è¡¨ç¤º
          - **ãƒ›ãƒãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**: ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ãƒ»åœæ­¢æ©Ÿèƒ½
          
          ### ğŸš€ ä½¿ã„æ–¹
          1. ãŠä½¿ã„ã®ç’°å¢ƒã«é©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸexeãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
          3. æ™‚é–“è¨­å®šã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼é¸æŠã€é…ç½®ä½ç½®ã‚’è¨­å®š
          4. ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
          
          ### ğŸ’» å‹•ä½œç’°å¢ƒ
          - Windows 10/11
          - Framework-dependentç‰ˆ: .NET 8.0 Desktop Runtimeå¿…è¦
          - Self-containedç‰ˆ: è¿½åŠ ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ä¸è¦
          
          ---
          ğŸ“… **Build Date**: ${{ github.event.head_commit.timestamp }}  
          ğŸ”— **Commit**: ${{ github.sha }}
        files: |
          ./release/RemMeter-framework-dependent-win-x64.exe
          ./release/RemMeter-framework-dependent-win-x86.exe
          ./release/RemMeter-self-contained-win-x64.exe
          ./release/RemMeter-self-contained-win-x86.exe
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-tagged:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    # Framework-dependent builds for release
    - name: Publish Framework-dependent Windows x64 for Release
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x64 --self-contained false --output ./release/framework-dependent/win-x64 --property:PublishSingleFile=true
      
    - name: Publish Framework-dependent Windows x86 for Release
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x86 --self-contained false --output ./release/framework-dependent/win-x86 --property:PublishSingleFile=true
      
    # Self-contained builds for release
    - name: Publish Self-contained Windows x64 for Release
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x64 --self-contained true --output ./release/self-contained/win-x64 --property:PublishSingleFile=true --property:PublishTrimmed=false
      
    - name: Publish Self-contained Windows x86 for Release
      run: dotnet publish wpf/RemMeter.csproj --configuration Release --runtime win-x86 --self-contained true --output ./release/self-contained/win-x86 --property:PublishSingleFile=true --property:PublishTrimmed=false
      
    # Rename files for clarity
    - name: Rename release files
      run: |
        mv "./release/framework-dependent/win-x64/RemMeter.exe" "./release/RemMeter-framework-dependent-win-x64.exe"
        mv "./release/framework-dependent/win-x86/RemMeter.exe" "./release/RemMeter-framework-dependent-win-x86.exe"
        mv "./release/self-contained/win-x64/RemMeter.exe" "./release/RemMeter-self-contained-win-x64.exe"
        mv "./release/self-contained/win-x86/RemMeter.exe" "./release/RemMeter-self-contained-win-x86.exe"
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release/RemMeter-framework-dependent-win-x64.exe
          ./release/RemMeter-framework-dependent-win-x86.exe
          ./release/RemMeter-self-contained-win-x64.exe
          ./release/RemMeter-self-contained-win-x86.exe
        name: RemMeter ${{ github.ref_name }}
        body: |
          ## RemMeter - WPFç‰ˆ
          
          ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
          
          ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          #### ğŸ¯ æ¨å¥¨ï¼šFramework-dependentç‰ˆï¼ˆå°ã•ã„ã‚µã‚¤ã‚ºï¼‰
          - **RemMeter-framework-dependent-win-x64.exe** - 64bit Windowsç”¨ï¼ˆç´„5-10MBï¼‰
          - **RemMeter-framework-dependent-win-x86.exe** - 32bit Windowsç”¨ï¼ˆç´„5-10MBï¼‰
          
          âš ï¸ **è¦ä»¶**: .NET 8.0 Desktop RuntimeãŒå¿…è¦ã§ã™
          - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ã‚¢ãƒ—ãƒªå®Ÿè¡Œæ™‚ã«è‡ªå‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã«æ¡ˆå†…ã•ã‚Œã¾ã™
          - [.NET 8.0 Desktop Runtime ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://dotnet.microsoft.com/download/dotnet/8.0)
          
          #### ğŸ”§ Self-containedç‰ˆï¼ˆå¤§ãã„ã‚µã‚¤ã‚ºã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸è¦ï¼‰
          - **RemMeter-self-contained-win-x64.exe** - 64bit Windowsç”¨ï¼ˆç´„80-120MBï¼‰
          - **RemMeter-self-contained-win-x86.exe** - 32bit Windowsç”¨ï¼ˆç´„80-120MBï¼‰
          
          âœ… **.NETãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¸è¦** - ã©ã®Windows PCã§ã‚‚ãã®ã¾ã¾å®Ÿè¡Œå¯èƒ½
          
          ### âœ¨ ä¸»è¦æ©Ÿèƒ½
          - **4ã¤ã®é…ç½®ä½ç½®**: å³ç«¯ãƒ»å·¦ç«¯ãƒ»ä¸Šç«¯ãƒ»ä¸‹ç«¯ã‹ã‚‰é¸æŠå¯èƒ½
          - **ãƒãƒ«ãƒãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼å¯¾å¿œ**: è¡¨ç¤ºã™ã‚‹ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼ã‚’é¸æŠå¯èƒ½
          - **è¦–è¦šçš„ãªé€²æ—è¡¨ç¤º**: æ®µéšçš„ãªè‰²å¤‰åŒ–ï¼ˆç·‘â†’ã‚ªãƒ¬ãƒ³ã‚¸â†’èµ¤è‰²ç‚¹æ»…ï¼‰
          - **Always on top**: ä»–ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¸Šã«å¸¸ã«è¡¨ç¤º
          - **ãƒ›ãƒãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«**: ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ãƒ»åœæ­¢æ©Ÿèƒ½
          
          ### ğŸš€ ä½¿ã„æ–¹
          1. ãŠä½¿ã„ã®ç’°å¢ƒã«é©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸexeãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
          3. æ™‚é–“è¨­å®šã€ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ãƒ¼é¸æŠã€é…ç½®ä½ç½®ã‚’è¨­å®š
          4. ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
          
          ### ğŸ’» å‹•ä½œç’°å¢ƒ
          - Windows 10/11
          - Framework-dependentç‰ˆ: .NET 8.0 Desktop Runtimeå¿…è¦
          - Self-containedç‰ˆ: è¿½åŠ ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ä¸è¦
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 